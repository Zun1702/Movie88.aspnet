### üí≥ Payment & Vouchers API Testing
### Complete payment flow from voucher validation to payment confirmation

# Switch between localhost and production
@baseUrl = https://movie88aspnet-app.up.railway.app/api
# @baseUrl = https://localhost:7238/api

### Variables
### Login to get JWT token first
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "ngoctrungtsn111@gmail.com",
  "password": "123321"
}

@token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiIxMSIsImVtYWlsIjoibmdvY3RydW5ndHNuMTExQGdtYWlsLmNvbSIsInVuaXF1ZV9uYW1lIjoiWnVuenVueiIsInJvbGUiOiJDdXN0b21lciIsImp0aSI6IjI2NmVhNTk0LWRmZWYtNDgxMy04MDdmLTA4M2M1ZTIwZDMwZiIsIm5iZiI6MTc2MjQyNjAyNywiZXhwIjoxNzYyNDI5NjI3LCJpYXQiOjE3NjI0MjYwMjcsImlzcyI6Ik1vdmllODhBUEkiLCJhdWQiOiJNb3ZpZTg4Q2xpZW50In0.7dcDksMtTGtrkdSnQtqOmuAtvYSnNnVhBUzx0jgK384
@bookingId = 15
@voucherCode = MOVIE50k
@paymentId = 3

###############################################
# üí∞ PHASE 1: VOUCHER MANAGEMENT
###############################################

### 1. POST Validate Voucher (REQUIRES AUTH)
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "{{voucherCode}}",
  "bookingid": {{bookingId}}
}

### 1.1 Validate - Invalid Voucher Code
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "INVALID_CODE",
  "bookingid": {{bookingId}}
}

### 1.2 Validate - Expired Voucher
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "EXPIRED2024",
  "bookingid": {{bookingId}}
}

###

### 2. POST Apply Voucher to Booking (REQUIRES AUTH)
POST {{baseUrl}}/bookings/{{bookingId}}/apply-voucher
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "{{voucherCode}}"
}

### 2.1 Apply - Try to Apply Same Voucher Again (should fail)
POST {{baseUrl}}/bookings/{{bookingId}}/apply-voucher
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "{{voucherCode}}"
}

###

### ERROR TEST: Validate without Auth (should return 401)
POST {{baseUrl}}/vouchers/validate
Content-Type: application/json

{
  "code": "{{voucherCode}}",
  "bookingid": {{bookingId}}
}

### ERROR TEST: Apply without Auth (should return 401)
POST {{baseUrl}}/bookings/{{bookingId}}/apply-voucher
Content-Type: application/json

{
  "code": "{{voucherCode}}"
}

###############################################
# üí≥ PHASE 2: VNPAY PAYMENT INTEGRATION
###############################################

### 3. POST Create VNPay Payment (REQUIRES AUTH)
### ‚úÖ RECOMMENDED for web testing (Chrome/Browser)
### Uses default ReturnUrl from config: https://movie88aspnet-app.up.railway.app/api/payments/vnpay/callback
### This ensures VNPay can redirect back to your API after payment
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": {{bookingId}}
}

### 3.1 Create Payment - Custom HTTPS Return URL (for custom web redirect)
### ‚úÖ Works on web browsers - VNPay redirects to your custom HTTPS URL
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": {{bookingId}},
  "returnurl": "https://yourdomain.com/payment-success"
}

### 3.2 Create Payment - Mobile App Deep Link
### ‚ö†Ô∏è WARNING: Only use this with MOBILE APP testing!
### Deep link scheme "movieapp://" will be BLOCKED on web browsers (Chrome/Firefox)
### causing payment button to be disabled. Use test case #3 for web testing instead.
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": {{bookingId}},
  "returnurl": "movieapp://payment/result"
}

###

### 4. GET VNPay Callback (NO AUTH - VNPay calls this)
### This will be called by VNPay after user completes payment
### Example callback URL with success response:
GET {{baseUrl}}/payments/vnpay/callback?vnp_Amount=20750000&vnp_BankCode=NCB&vnp_BankTranNo=VNP123456&vnp_CardType=ATM&vnp_OrderInfo=Thanh+toan+booking+156&vnp_PayDate=20251105154530&vnp_ResponseCode=00&vnp_TmnCode=1F8WTZLN&vnp_TransactionNo=123456789&vnp_TransactionStatus=00&vnp_TxnRef=PAY_20251105154500_156&vnp_SecureHash=HASH_VALUE

### 4.1 Callback - Failed Payment (ResponseCode != 00)
GET {{baseUrl}}/payments/vnpay/callback?vnp_Amount=20750000&vnp_BankCode=NCB&vnp_ResponseCode=24&vnp_TmnCode=1F8WTZLN&vnp_TransactionNo=123456789&vnp_TxnRef=PAY_20251105154500_156&vnp_SecureHash=HASH_VALUE

###

### 5. POST VNPay IPN (NO AUTH - VNPay calls this)
### VNPay sends POST request to notify server
POST {{baseUrl}}/payments/vnpay/ipn
Content-Type: application/x-www-form-urlencoded

vnp_Amount=20750000&vnp_BankCode=NCB&vnp_BankTranNo=VNP123456&vnp_CardType=ATM&vnp_OrderInfo=Thanh+toan+booking+156&vnp_PayDate=20251105154530&vnp_ResponseCode=00&vnp_TmnCode=1F8WTZLN&vnp_TransactionNo=123456789&vnp_TransactionStatus=00&vnp_TxnRef=PAY_20251105154500_156&vnp_SecureHash=HASH_VALUE

###

### 6. GET Payment Details (REQUIRES AUTH)
GET {{baseUrl}}/payments/{{paymentId}}
Authorization: Bearer {{token}}

### 6.1 Get Payment - Non-existent Payment
GET {{baseUrl}}/payments/99999
Authorization: Bearer {{token}}

###

### ERROR TEST: Create Payment without Auth (should return 401)
POST {{baseUrl}}/payments/vnpay/create
Content-Type: application/json

{
  "bookingid": {{bookingId}},
  "returnurl": "movieapp://payment/result"
}

### ERROR TEST: Get Payment without Auth (should return 401)
GET {{baseUrl}}/payments/{{paymentId}}

### ERROR TEST: Create Payment for Non-existent Booking
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": 99999,
  "returnurl": "movieapp://payment/result"
}

### ERROR TEST: Create Payment for Already Paid Booking
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": 100,
  "returnurl": "movieapp://payment/result"
}

###############################################
# üìä PHASE 3: BOOKING INFO (ALREADY DONE)
###############################################

### 7-8. GET Booking Details (REQUIRES AUTH)
### See BookingFlow.http or Home.http for full booking details endpoint
GET {{baseUrl}}/bookings/{{bookingId}}
Authorization: Bearer {{token}}

###

###############################################
# üîÑ COMPLETE PAYMENT FLOW SCENARIO
###############################################

### SCENARIO: Complete payment flow from start to finish

# 1. Create booking (see BookingFlow.http)
# Result: bookingId = 156, totalamount = 415000, status = "Pending"

# 2. Validate voucher
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "STUDENT50",
  "bookingid": 156
}
# Result: discountvalue = 50%, applicableDiscount = 207500

# 3. Apply voucher
POST {{baseUrl}}/bookings/156/apply-voucher
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "STUDENT50"
}
# Result: totalamount = 207500 (50% discount)

# 4. Create VNPay payment
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": 156,
  "returnurl": "movieapp://payment/result"
}
# Result: paymentId = 22, vnpayUrl = "https://sandbox.vnpayment.vn/..."

# 5. User pays via VNPay (use test card)
# Card: 9704198526191432198, OTP: 123456

# 6. VNPay redirects to callback (automatic)
# Result: payment.status = "Completed", booking.status = "Confirmed", booking.bookingcode = "BK-20251105-XXXX"

# 7. Get payment details
GET {{baseUrl}}/payments/22
Authorization: Bearer {{token}}
# Result: Shows completed payment with BookingCode

# 8. Get booking details (verify BookingCode)
GET {{baseUrl}}/bookings/156
Authorization: Bearer {{token}}
# Result: Shows confirmed booking with BookingCode for QR scanning

###############################################
# üìä DATA VALIDATION TESTS
###############################################

### TEST: Voucher discount calculation (percentage)
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "DISCOUNT10",
  "bookingid": 156
}
# Verify: applicableDiscount = totalamount √ó 10%

### TEST: Voucher discount calculation (fixed)
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "FIXED50K",
  "bookingid": 156
}
# Verify: applicableDiscount = 50000

### TEST: Minimum purchase requirement
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "VIP200K",
  "bookingid": 50
}
# Should fail if booking.totalamount < 200000

### TEST: Usage limit exceeded
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "LIMITED10",
  "bookingid": 156
}
# Should fail if voucher.usedcount >= voucher.usagelimit

### TEST: VNPay amount conversion
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": 156,
  "returnurl": "movieapp://payment/result"
}
# Verify: vnpayUrl contains vnp_Amount = (totalamount √ó 100)
# Example: 207500 VND ‚Üí vnp_Amount=20750000

### TEST: Transaction code format
# Verify: transactioncode = "PAY_YYYYMMDDHHMMSS_bookingId"
# Example: "PAY_20251105154500_156"

### TEST: BookingCode generation after payment
# Before payment: booking.bookingcode = null
# After callback with ResponseCode=00: booking.bookingcode = "BK-20251105-0156"

###############################################
# üéØ PERFORMANCE TESTS
###############################################

### LOAD TEST: Validate voucher (should be fast)
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "STUDENT50",
  "bookingid": 156
}

### LOAD TEST: Create payment (should handle VNPay URL generation)
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": 156,
  "returnurl": "movieapp://payment/result"
}

###############################################
# üîí SECURITY TESTS
###############################################

### TEST: Cannot validate other user's booking voucher
POST {{baseUrl}}/vouchers/validate
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "STUDENT50",
  "bookingid": 999
}
# Should return 403 Forbidden

### TEST: Cannot apply voucher to other user's booking
POST {{baseUrl}}/bookings/999/apply-voucher
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "code": "STUDENT50"
}
# Should return 403 Forbidden

### TEST: Cannot create payment for other user's booking
POST {{baseUrl}}/payments/vnpay/create
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "bookingid": 999,
  "returnurl": "movieapp://payment/result"
}
# Should return 403 Forbidden

### TEST: Cannot get other user's payment details
GET {{baseUrl}}/payments/999
Authorization: Bearer {{token}}
# Should return 403 Forbidden

### TEST: VNPay secure hash validation
# Callback with invalid hash should be rejected
GET {{baseUrl}}/payments/vnpay/callback?vnp_Amount=20750000&vnp_ResponseCode=00&vnp_TxnRef=PAY_20251105154500_156&vnp_SecureHash=INVALID_HASH
# Should return 400 Bad Request

###############################################
# üß™ NOTES FOR TESTING
###############################################

# 1. Update @token with valid JWT token from login
# 2. Update @bookingId with actual booking ID from booking creation
# 3. Update @paymentId with actual payment ID from payment creation
# 4. Test VNPay payment flow:
#    - Create payment ‚Üí Get vnpayUrl
#    - Open vnpayUrl in browser
#    - Use test card: 9704198526191432198, OTP: 123456
#    - Complete payment on VNPay sandbox
#    - Verify callback updates payment and booking
#    - Check BookingCode is generated
# 5. Test voucher application BEFORE payment
# 6. Verify BookingCode is null before payment, set after payment
# 7. Test all error cases (expired, invalid, limit exceeded)

###############################################
# üîó RETURN URL EXPLANATION
###############################################

# ‚ö†Ô∏è IMPORTANT: Understanding ReturnUrl parameter

# 1. DEFAULT (No returnurl) - ‚úÖ RECOMMENDED FOR WEB TESTING
#    - Uses config: "https://localhost:7238/api/payments/vnpay/callback"
#    - VNPay redirects to your API
#    - API processes callback ‚Üí Updates database ‚Üí Returns HTML redirect
#    - Works perfectly on Chrome/Firefox/Edge

# 2. CUSTOM HTTPS URL - ‚úÖ Works on web browsers
#    - Example: "https://yourdomain.com/payment-success"
#    - VNPay redirects to your custom web page
#    - Your page receives query parameters (vnp_ResponseCode, vnp_TxnRef, etc.)
#    - You need to call API separately to verify payment status

# 3. MOBILE APP DEEP LINK - ‚ùå BLOCKED on web browsers
#    - Example: "movieapp://payment/result"
#    - This is URL scheme for mobile app (like opening app from link)
#    - Android/iOS apps register custom schemes in AndroidManifest.xml/Info.plist
#    - Web browsers DON'T understand these schemes ‚Üí Payment button disabled
#    - ONLY use this when testing with REAL mobile app

# üí° WHY test case #3.2 fails on Chrome:
#    1. You create payment with returnurl: "movieapp://payment/result"
#    2. VNPay tries to redirect to movieapp://payment/result?vnp_...
#    3. Chrome doesn't know what "movieapp://" is (no app installed)
#    4. Chrome blocks the redirect ‚Üí Payment button becomes unresponsive
#    5. Solution: Use test case #3 (no returnurl) for web testing!

# üì± Mobile App Flow (when using deep link):
#    1. App calls API: POST /payments/vnpay/create with deep link returnurl
#    2. App opens VNPay URL in WebView/Browser
#    3. User completes payment
#    4. VNPay redirects to: movieapp://payment/result?vnp_ResponseCode=00...
#    5. Mobile OS opens your app with these parameters
#    6. App parses parameters ‚Üí Calls API to verify payment status
#    7. App shows success/failure screen

###############################################
# ‚úÖ EXPECTED RESULTS
###############################################

# Phase 1 (Voucher):
# - POST /api/vouchers/validate ‚Üí 200 OK with discount calculation
# - POST /api/bookings/{id}/apply-voucher ‚Üí 200 OK with updated totalamount
#   - Booking.totalamount reduced by discount
#   - Voucher.usedcount incremented
#   - Booking.voucherid set

# Phase 2 (VNPay Payment):
# - POST /api/payments/vnpay/create ‚Üí 200 OK with vnpayUrl
#   - Payment record created with status "Pending"
#   - Transaction code generated: PAY_YYYYMMDDHHMMSS_bookingId
# - GET /api/payments/vnpay/callback ‚Üí HTML redirect
#   - Payment.status: "Pending" ‚Üí "Completed"
#   - Booking.status: "Pending" ‚Üí "Confirmed"
#   - **Booking.bookingcode: null ‚Üí "BK-YYYYMMDD-XXXX"** (Generated!)
# - POST /api/payments/vnpay/ipn ‚Üí {"RspCode": "00"}
#   - Same updates as callback
# - GET /api/payments/{id} ‚Üí 200 OK with payment details
#   - Includes method info, booking info with BookingCode

# Phase 3 (Booking Info):
# - GET /api/bookings/{id} ‚Üí 200 OK with full booking details
#   - Shows BookingCode after payment confirmed
#   - Shows applied voucher discount
#   - Status is "Confirmed"

###############################################
# üöÄ NEXT STEPS AFTER PAYMENT
###############################################

# After completing payment flow:
# 1. Booking has BookingCode (e.g., "BK-20251105-0156")
# 2. User can view booking details with QR code
# 3. Staff can scan QR code to verify booking (see Staff.http)
# 4. User can view booking history (see Home.http)

###
